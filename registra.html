<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro Firma Digitale - Registrazione</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="container">
    <h1>Modulo di Registrazione Firma</h1>

    <form id="firmaForm">
      <label>Nome:</label>
      <input type="text" id="nome" required />

      <label>Cognome:</label>
      <input type="text" id="cognome" required />

      <label>Email:</label>
      <input type="email" id="email" readonly />

      <label>Firma Digitale:</label>
      <canvas id="firmaCanvas" width="400" height="150"></canvas>
      <div class="canvas-buttons">
        <button type="button" id="clearCanvas">Cancella</button>
      </div>

      <button type="submit">Salva nel Registro</button>
    </form>

    <div id="message"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("firmaForm");
      const canvas = document.getElementById("firmaCanvas");
      const ctx = canvas.getContext("2d");
      const clearBtn = document.getElementById("clearCanvas");
      const messageDiv = document.getElementById("message");
      let drawing = false;

      // Legge email e token dalla querystring
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");
      const emailParam = params.get("email");

      if (!token || !emailParam) {
        alert("Link non valido. Torna alla pagina iniziale e genera un nuovo QR.");
        window.location.href = "index.html";
        return;
      }
      document.getElementById("email").value = decodeURIComponent(emailParam);

      function getPointerPos(e) {
        const rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches[0]) {
          return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
        } else {
          return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }
      }

      // Mouse
      canvas.addEventListener("mousedown", () => drawing = true);
      canvas.addEventListener("mouseup", () => { drawing = false; ctx.beginPath(); });
      canvas.addEventListener("mouseleave", () => { drawing = false; ctx.beginPath(); });
      canvas.addEventListener("mousemove", (e) => {
        if (!drawing) return;
        const p = getPointerPos(e);
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#000";
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
      });

      // Touch
      canvas.addEventListener("touchstart", (e) => { e.preventDefault(); drawing = true; });
      canvas.addEventListener("touchend", () => { drawing = false; ctx.beginPath(); });
      canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        if (!drawing) return;
        const p = getPointerPos(e);
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#000";
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
      });

      clearBtn.addEventListener("click", () => ctx.clearRect(0, 0, canvas.width, canvas.height));

      function getArchivio() {
        return JSON.parse(localStorage.getItem("registroFirme") || "[]");
      }
      function salvaArchivio(dati) {
        localStorage.setItem("registroFirme", JSON.stringify(dati));
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const nome = document.getElementById("nome").value.trim();
        const cognome = document.getElementById("cognome").value.trim();
        const email = document.getElementById("email").value.trim();
        const firma = canvas.toDataURL("image/png");

        if (!nome || !cognome) {
          messageDiv.textContent = "Compila tutti i campi.";
          messageDiv.style.color = "red";
          return;
        }

        const nuovoRecord = {
          nome,
          cognome,
          email,
          token,
          data: new Date().toLocaleString("it-IT"),
          firma
        };

        const archivio = getArchivio();
        archivio.push(nuovoRecord);
        salvaArchivio(archivio);

        messageDiv.textContent = "âœ… Registrazione completata con successo!";
        messageDiv.style.color = "green";
      });
    });
  </script>
</body>
</html>
